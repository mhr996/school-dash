import { NextRequest, NextResponse } from 'next/server';
import { PDFService } from '@/utils/pdf-service';

export async function POST(request: NextRequest) {
    try {
        const { bookingData, language = 'he', filename = 'booking-summary.pdf', options = {} } = await request.json();

        if (!bookingData) {
            return NextResponse.json({ error: 'Booking data is required' }, { status: 400 });
        }

        // Generate HTML from booking data
        const htmlContent = await generateBookingHTML(bookingData, language);

        // Generate PDF using Puppeteer
        const pdfService = PDFService.getInstance();
        const pdfBuffer = await pdfService.generateContractPDF({
            contractHtml: htmlContent,
            filename,
            ...options,
        });

        // Return PDF as response
        return new NextResponse(Buffer.from(pdfBuffer), {
            status: 200,
            headers: {
                'Content-Type': 'application/pdf',
                'Content-Disposition': `attachment; filename="${filename}"`,
                'Content-Length': pdfBuffer.length.toString(),
            },
        });
    } catch (error) {
        console.error('Booking PDF generation error:', error);
        return NextResponse.json({ error: 'Failed to generate PDF', details: error instanceof Error ? error.message : 'Unknown error' }, { status: 500 });
    }
}

/**
 * Generate HTML from booking data
 */
async function generateBookingHTML(bookingData: any, language: string): Promise<string> {
    // Import company info function
    const { getCompanyInfo } = await import('@/lib/company-info');

    try {
        const companyInfo = await getCompanyInfo(true); // Use service role for API routes

        // Generate HTML based on language
        switch (language) {
            case 'en':
                return generateEnglishBookingHTML(bookingData, companyInfo);
            case 'ae':
                return generateArabicBookingHTML(bookingData, companyInfo);
            case 'he':
                return generateHebrewBookingHTML(bookingData, companyInfo);
            default:
                return generateEnglishBookingHTML(bookingData, companyInfo);
        }
    } catch (error) {
        console.warn('Failed to load company info, using defaults:', error);
        const defaultCompanyInfo = {
            name: 'School Trips Company',
            address: null,
            phone: null,
            tax_number: null,
            logo_url: null,
        };

        switch (language) {
            case 'en':
                return generateEnglishBookingHTML(bookingData, defaultCompanyInfo);
            case 'ae':
                return generateArabicBookingHTML(bookingData, defaultCompanyInfo);
            case 'he':
                return generateHebrewBookingHTML(bookingData, defaultCompanyInfo);
            default:
                return generateEnglishBookingHTML(bookingData, defaultCompanyInfo);
        }
    }
}

/**
 * Generate English booking HTML
 */
function generateEnglishBookingHTML(booking: any, companyInfo: any): string {
    const formatCurrency = (value: number) => {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'ILS',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
        }).format(value);
    };

    const formatDate = (dateString: string) => {
        return new Date(dateString).toLocaleDateString('en-GB', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
        });
    };

    const getBookingTypeLabel = (bookingType: string): string => {
        const labels: { [key: string]: string } = {
            full_trip: 'Full Trip',
            guides_only: 'Guides Only',
            paramedics_only: 'Paramedics Only',
            security_only: 'Security Only',
            entertainment_only: 'Entertainment Only',
            education_only: 'Education Only',
            transportation_only: 'Transportation Only',
        };
        return labels[bookingType] || bookingType;
    };

    const getStatusLabel = (status: string): string => {
        const labels: { [key: string]: string } = {
            pending: 'Pending',
            confirmed: 'Confirmed',
            completed: 'Completed',
            cancelled: 'Cancelled',
            active: 'Active',
            inactive: 'Inactive',
        };
        return labels[status] || status;
    };

    const getPaymentStatusLabel = (status: string): string => {
        const labels: { [key: string]: string } = {
            pending: 'Pending',
            deposit_paid: 'Deposit Paid',
            fully_paid: 'Fully Paid',
            paid: 'Paid',
            cancelled: 'Cancelled',
        };
        return labels[status] || status;
    };

    const getServiceTypeLabel = (serviceType: string): string => {
        const labels: { [key: string]: string } = {
            guides: 'Guides',
            paramedics: 'Paramedics',
            security_companies: 'Security Companies',
            external_entertainment_companies: 'Entertainment Companies',
            travel_companies: 'Travel Companies',
            education_programs: 'Education Programs',
        };
        return labels[serviceType] || serviceType;
    };

    const getPaymentMethodLabel = (paymentMethod: string): string => {
        const labels: { [key: string]: string } = {
            bank_transfer: 'Bank Transfer',
            cash: 'Cash',
            credit_card: 'Credit Card',
            check: 'Check',
        };
        return labels[paymentMethod] || paymentMethod;
    };

    return `
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Booking Summary - ${booking.booking_reference}</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            @page { size: A4; margin: 8mm; }
            body { 
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                font-size: 11px; 
                line-height: 1.4; 
            }
            .avoid-break-inside { page-break-inside: avoid; }
            .compact-section { margin-bottom: 8px; }
            .compact-header { padding: 12px 16px; }
            .compact-content { padding: 14px; }
        </style>
    </head>
    <body>
        <div class="bg-white w-full max-w-none" style="direction: ltr">
            <!-- Header -->
            <div class="relative overflow-hidden w-full avoid-break-inside">
                <div class="absolute inset-0 bg-gradient-to-r from-blue-600 to-indigo-600"></div>
                
                <div class="relative compact-header w-full">
                    <div class="flex items-center justify-between w-full">
                        <!-- Company Info -->
                        <div class="flex items-center gap-3 text-white">
                            ${
                                companyInfo?.logo_url
                                    ? `
                                <div class="bg-white/10 backdrop-blur-sm rounded-lg p-2 border border-white/20">
                                    <img src="${companyInfo.logo_url}" alt="Company Logo" class="w-10 h-10 object-contain" />
                                </div>
                            `
                                    : ''
                            }
                            <div class="text-left">
                                <h1 class="text-lg font-bold mb-0.5">${companyInfo?.name || 'School Trips Company'}</h1>
                                <div class="space-y-0.5 text-xs opacity-90">
                                    ${companyInfo?.phone ? `<p>üìû ${companyInfo.phone}</p>` : ''}
                                    ${companyInfo?.address ? `<p>üìç ${companyInfo.address}</p>` : ''}
                                </div>
                            </div>
                        </div>

                        <!-- Booking Title -->
                        <div class="text-white text-right">
                            <h2 class="text-base font-bold mb-1">Booking Summary</h2>
                            <div class="bg-white/10 backdrop-blur-sm rounded-lg px-3 py-1.5 border border-white/20">
                                <p class="text-xs font-medium">Reference #</p>
                                <p class="text-sm font-bold">${booking.booking_reference}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content -->
            <div class="compact-content space-y-3 w-full">
                <!-- Booking Details -->
                <div class="grid grid-cols-2 gap-3 w-full compact-section avoid-break-inside">
                    <!-- Main Info -->
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-3 border border-blue-200">
                        <h3 class="font-bold mb-2 text-sm text-blue-700 flex items-center gap-2">
                            üìã Booking Information
                        </h3>
                        <div class="space-y-1 text-xs">
                            <p><span class="font-semibold text-blue-700">Type:</span> ${getBookingTypeLabel(booking.booking_type)}</p>
                            <p><span class="font-semibold text-blue-700">Trip Date:</span> ${formatDate(booking.trip_date)}</p>
                            <p><span class="font-semibold text-blue-700">Status:</span> ${getStatusLabel(booking.status)}</p>
                            <p><span class="font-semibold text-blue-700">Payment Status:</span> ${getPaymentStatusLabel(booking.payment_status)}</p>
                        </div>
                    </div>

                    <!-- Customer Info -->
                    <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg p-3 border border-green-200">
                        <h3 class="font-bold mb-2 text-sm text-green-700 flex items-center gap-2">
                            üë§ Customer Information
                        </h3>
                        <div class="space-y-1 text-xs">
                            <p><span class="font-semibold text-green-700">Name:</span> ${booking.customer?.full_name || 'N/A'}</p>
                            <p><span class="font-semibold text-green-700">Email:</span> ${booking.customer?.email || 'N/A'}</p>
                            <p><span class="font-semibold text-green-700">Phone:</span> ${booking.customer?.phone || 'N/A'}</p>
                            ${booking.school?.name ? `<p><span class="font-semibold text-green-700">School:</span> ${booking.school.name}</p>` : ''}
                        </div>
                    </div>
                </div>

                ${
                    booking.destination
                        ? `
                <!-- Destination -->
                <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg p-3 border border-purple-200 compact-section avoid-break-inside">
                    <h3 class="font-bold mb-2 text-sm text-purple-700 flex items-center gap-2">
                        üìç Destination
                    </h3>
                    <div class="space-y-1 text-xs">
                        <p><span class="font-semibold text-purple-700">Name:</span> ${booking.destination.name}</p>
                        ${booking.destination.address ? `<p><span class="font-semibold text-purple-700">Address:</span> ${booking.destination.address}</p>` : ''}
                    </div>
                </div>
                `
                        : ''
                }

                ${
                    booking.number_of_students || booking.number_of_crew || booking.number_of_buses
                        ? `
                <!-- Trip Details -->
                <div class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-lg p-3 border border-yellow-200 compact-section avoid-break-inside">
                    <h3 class="font-bold mb-2 text-sm text-yellow-700 flex items-center gap-2">
                        üöå Trip Details
                    </h3>
                    <div class="grid grid-cols-3 gap-2 text-xs">
                        ${booking.number_of_students ? `<p><span class="font-semibold text-yellow-700">Students:</span> ${booking.number_of_students}</p>` : ''}
                        ${booking.number_of_crew ? `<p><span class="font-semibold text-yellow-700">Crew:</span> ${booking.number_of_crew}</p>` : ''}
                        ${booking.number_of_buses ? `<p><span class="font-semibold text-yellow-700">Buses:</span> ${booking.number_of_buses}</p>` : ''}
                    </div>
                </div>
                `
                        : ''
                }

                ${
                    booking.services && booking.services.length > 0
                        ? `
                <!-- Services -->
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200 compact-section avoid-break-inside">
                    <h3 class="font-bold mb-2 text-sm text-gray-700 flex items-center gap-2">
                        üéØ Booked Services
                    </h3>
                    <table class="w-full text-xs">
                        <thead>
                            <tr class="bg-gray-200 text-left">
                                <th class="p-1.5 font-semibold">Service</th>
                                <th class="p-1.5 font-semibold">Type</th>
                                <th class="p-1.5 font-semibold text-center">Qty</th>
                                <th class="p-1.5 font-semibold text-center">Days</th>
                                <th class="p-1.5 font-semibold text-right">Price</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${booking.services
                                .map(
                                    (service: any, index: number) => `
                                <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                    <td class="p-1.5">${service.name || 'N/A'}</td>
                                    <td class="p-1.5">${getServiceTypeLabel(service.type)}</td>
                                    <td class="p-1.5 text-center">${service.quantity}</td>
                                    <td class="p-1.5 text-center">${service.days}</td>
                                    <td class="p-1.5 text-right font-semibold">${formatCurrency(service.cost)}</td>
                                </tr>
                            `,
                                )
                                .join('')}
                        </tbody>
                    </table>
                </div>
                `
                        : ''
                }

                <!-- Financial Summary -->
                <div class="bg-gradient-to-br from-indigo-50 to-blue-50 rounded-lg p-3 border border-indigo-200 compact-section avoid-break-inside">
                    <h3 class="font-bold mb-2 text-sm text-indigo-700 flex items-center gap-2">
                        üí∞ Financial Summary
                    </h3>
                    <div class="space-y-1.5">
                        <div class="flex justify-between items-center text-xs">
                            <span class="font-semibold text-indigo-700">Total Amount:</span>
                            <span class="text-lg font-bold text-indigo-700">${formatCurrency(booking.total_amount)}</span>
                        </div>
                        <div class="flex justify-between items-center text-xs">
                            <span class="font-semibold text-indigo-700">Payment Method:</span>
                            <span>${getPaymentMethodLabel(booking.payment_method) || 'N/A'}</span>
                        </div>
                    </div>
                </div>

                ${
                    booking.notes || booking.special_requests
                        ? `
                <!-- Notes -->
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200 compact-section avoid-break-inside">
                    <h3 class="font-bold mb-2 text-sm text-gray-700 flex items-center gap-2">
                        üìù Additional Information
                    </h3>
                    <div class="space-y-1.5 text-xs">
                        ${booking.notes ? `<p><span class="font-semibold text-gray-700">Notes:</span> ${booking.notes}</p>` : ''}
                        ${booking.special_requests ? `<p><span class="font-semibold text-gray-700">Special Requests:</span> ${booking.special_requests}</p>` : ''}
                    </div>
                </div>
                `
                        : ''
                }

                <!-- Footer -->
                <div class="text-center text-xs text-gray-500 pt-2 border-t border-gray-200">
                    <p>Generated on ${new Date().toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                </div>
            </div>
        </div>
    </body>
    </html>
    `;
}

/**
 * Generate Arabic booking HTML
 */
function generateArabicBookingHTML(booking: any, companyInfo: any): string {
    const formatCurrency = (value: number) => {
        // Use English numbers for Arabic
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'ILS',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
        }).format(value);
    };

    const formatDate = (dateString: string) => {
        // Use English numbers for dates
        return new Date(dateString).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
        });
    };

    const getBookingTypeLabel = (bookingType: string): string => {
        const labels: { [key: string]: string } = {
            full_trip: 'ÿ±ÿ≠ŸÑÿ© ŸÉÿßŸÖŸÑÿ©',
            guides_only: 'ŸÖÿ±ÿ¥ÿØŸäŸÜ ŸÅŸÇÿ∑',
            paramedics_only: 'ŸÖÿ≥ÿπŸÅŸäŸÜ ŸÅŸÇÿ∑',
            security_only: 'ÿ£ŸÖŸÜ ŸÅŸÇÿ∑',
            entertainment_only: 'ÿ™ÿ±ŸÅŸäŸá ŸÅŸÇÿ∑',
            education_only: 'ÿ®ÿ±ÿßŸÖÿ¨ ÿ™ÿπŸÑŸäŸÖŸäÿ© ŸÅŸÇÿ∑',
            transportation_only: 'ŸÜŸÇŸÑ ŸÅŸÇÿ∑',
        };
        return labels[bookingType] || bookingType;
    };

    const getStatusLabel = (status: string): string => {
        const labels: { [key: string]: string } = {
            pending: 'ŸÇŸäÿØ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±',
            confirmed: 'ŸÖÿ§ŸÉÿØ',
            completed: 'ŸÖŸÉÿ™ŸÖŸÑ',
            cancelled: 'ŸÖŸÑÿ∫Ÿä',
            active: 'ŸÜÿ¥ÿ∑',
            inactive: 'ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑',
        };
        return labels[status] || status;
    };

    const getPaymentStatusLabel = (status: string): string => {
        const labels: { [key: string]: string } = {
            pending: 'ŸÇŸäÿØ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±',
            deposit_paid: 'ÿ™ŸÖ ÿØŸÅÿπ ÿßŸÑÿπÿ±ÿ®ŸàŸÜ',
            fully_paid: 'ŸÖÿØŸÅŸàÿπ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ',
            paid: 'ŸÖÿØŸÅŸàÿπ',
            cancelled: 'ŸÖŸÑÿ∫Ÿä',
        };
        return labels[status] || status;
    };

    const getServiceTypeLabel = (serviceType: string): string => {
        const labels: { [key: string]: string } = {
            guides: 'ŸÖÿ±ÿ¥ÿØŸäŸÜ',
            paramedics: 'ŸÖÿ≥ÿπŸÅŸäŸÜ',
            security_companies: 'ÿ¥ÿ±ŸÉÿßÿ™ ÿ£ŸÖŸÜ',
            external_entertainment_companies: 'ÿ¥ÿ±ŸÉÿßÿ™ ÿ™ÿ±ŸÅŸäŸá',
            travel_companies: 'ÿ¥ÿ±ŸÉÿßÿ™ ÿ≥ŸÅÿ±',
            education_programs: 'ÿ®ÿ±ÿßŸÖÿ¨ ÿ™ÿπŸÑŸäŸÖŸäÿ©',
        };
        return labels[serviceType] || serviceType;
    };

    const getPaymentMethodLabel = (paymentMethod: string): string => {
        const labels: { [key: string]: string } = {
            bank_transfer: 'ÿ™ÿ≠ŸàŸäŸÑ ÿ®ŸÜŸÉŸä',
            cash: 'ŸÜŸÇÿØÿßŸã',
            credit_card: 'ÿ®ÿ∑ÿßŸÇÿ© ÿßÿ¶ÿ™ŸÖÿßŸÜ',
            check: 'ÿ¥ŸäŸÉ',
        };
        return labels[paymentMethod] || paymentMethod;
    };

    return `
    <!DOCTYPE html>
    <html lang="ar">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ŸÖŸÑÿÆÿµ ÿßŸÑÿ≠ÿ¨ÿ≤ - ${booking.booking_reference}</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">
        <style>
            @page { size: A4; margin: 8mm; }
            body { 
                font-family: 'Noto Kufi Arabic', 'Cairo', 'Segoe UI', sans-serif; 
                font-size: 11px; 
                line-height: 1.4; 
            }
            .avoid-break-inside { page-break-inside: avoid; }
            .compact-section { margin-bottom: 8px; }
            .compact-header { padding: 12px 16px; }
            .compact-content { padding: 14px; }
        </style>
    </head>
    <body>
        <div class="bg-white w-full max-w-none" style="direction: rtl">
            <!-- Header -->
            <div class="relative overflow-hidden w-full avoid-break-inside">
                <div class="absolute inset-0 bg-gradient-to-r from-blue-600 to-indigo-600"></div>
                
                <div class="relative compact-header w-full">
                    <div class="flex items-center justify-between w-full">
                        <!-- Company Info -->
                        <div class="flex items-center gap-3 text-white">
                            ${
                                companyInfo?.logo_url
                                    ? `
                                <div class="bg-white/10 backdrop-blur-sm rounded-lg p-2 border border-white/20">
                                    <img src="${companyInfo.logo_url}" alt="ÿ¥ÿπÿßÿ± ÿßŸÑÿ¥ÿ±ŸÉÿ©" class="w-10 h-10 object-contain" />
                                </div>
                            `
                                    : ''
                            }
                            <div class="text-right">
                                <h1 class="text-lg font-bold mb-0.5">${companyInfo?.name || 'ÿ¥ÿ±ŸÉÿ© ÿ±ÿ≠ŸÑÿßÿ™ ŸÖÿØÿ±ÿ≥Ÿäÿ©'}</h1>
                                <div class="space-y-0.5 text-xs opacity-90">
                                    ${companyInfo?.phone ? `<p>üìû ${companyInfo.phone}</p>` : ''}
                                    ${companyInfo?.address ? `<p>üìç ${companyInfo.address}</p>` : ''}
                                </div>
                            </div>
                        </div>

                        <!-- Booking Title -->
                        <div class="text-white text-left">
                            <h2 class="text-base font-bold mb-1">ŸÖŸÑÿÆÿµ ÿßŸÑÿ≠ÿ¨ÿ≤</h2>
                            <div class="bg-white/10 backdrop-blur-sm rounded-lg px-3 py-1.5 border border-white/20">
                                <p class="text-xs font-medium">ÿ±ŸÇŸÖ ÿßŸÑŸÖÿ±ÿ¨ÿπ</p>
                                <p class="text-sm font-bold">${booking.booking_reference}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content -->
            <div class="compact-content space-y-3 w-full">
                <!-- Booking Details -->
                <div class="grid grid-cols-2 gap-3 w-full compact-section avoid-break-inside">
                    <!-- Main Info -->
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-3 border border-blue-200">
                        <h3 class="font-bold mb-2 text-sm text-blue-700 flex items-center gap-2">
                            üìã ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ≠ÿ¨ÿ≤
                        </h3>
                        <div class="space-y-1 text-xs">
                            <p><span class="font-semibold text-blue-700">ÿßŸÑŸÜŸàÿπ:</span> ${getBookingTypeLabel(booking.booking_type)}</p>
                            <p><span class="font-semibold text-blue-700">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ±ÿ≠ŸÑÿ©:</span> ${formatDate(booking.trip_date)}</p>
                            <p><span class="font-semibold text-blue-700">ÿßŸÑÿ≠ÿßŸÑÿ©:</span> ${getStatusLabel(booking.status)}</p>
                            <p><span class="font-semibold text-blue-700">ÿ≠ÿßŸÑÿ© ÿßŸÑÿØŸÅÿπ:</span> ${getPaymentStatusLabel(booking.payment_status)}</p>
                        </div>
                    </div>

                    <!-- Customer Info -->
                    <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg p-3 border border-green-200">
                        <h3 class="font-bold mb-2 text-sm text-green-700 flex items-center gap-2">
                            üë§ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿπŸÖŸäŸÑ
                        </h3>
                        <div class="space-y-1 text-xs">
                            <p><span class="font-semibold text-green-700">ÿßŸÑÿßÿ≥ŸÖ:</span> ${booking.customer?.full_name || 'ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±'}</p>
                            <p><span class="font-semibold text-green-700">ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä:</span> ${booking.customer?.email || 'ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±'}</p>
                            <p><span class="font-semibold text-green-700">ÿßŸÑŸáÿßÿ™ŸÅ:</span> ${booking.customer?.phone || 'ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±'}</p>
                            ${booking.school?.name ? `<p><span class="font-semibold text-green-700">ÿßŸÑŸÖÿØÿ±ÿ≥ÿ©:</span> ${booking.school.name}</p>` : ''}
                        </div>
                    </div>
                </div>

                ${
                    booking.destination
                        ? `
                <!-- Destination -->
                <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg p-3 border border-purple-200 compact-section avoid-break-inside">
                    <h3 class="font-bold mb-2 text-sm text-purple-700 flex items-center gap-2">
                        üìç ÿßŸÑŸàÿ¨Ÿáÿ©
                    </h3>
                    <div class="space-y-1 text-xs">
                        <p><span class="font-semibold text-purple-700">ÿßŸÑÿßÿ≥ŸÖ:</span> ${booking.destination.name}</p>
                        ${booking.destination.address ? `<p><span class="font-semibold text-purple-700">ÿßŸÑÿπŸÜŸàÿßŸÜ:</span> ${booking.destination.address}</p>` : ''}
                    </div>
                </div>
                `
                        : ''
                }

                ${
                    booking.number_of_students || booking.number_of_crew || booking.number_of_buses
                        ? `
                <!-- Trip Details -->
                <div class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-lg p-3 border border-yellow-200 compact-section avoid-break-inside">
                    <h3 class="font-bold mb-2 text-sm text-yellow-700 flex items-center gap-2">
                        üöå ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ±ÿ≠ŸÑÿ©
                    </h3>
                    <div class="grid grid-cols-3 gap-2 text-xs">
                        ${booking.number_of_students ? `<p><span class="font-semibold text-yellow-700">ÿßŸÑÿ∑ŸÑÿßÿ®:</span> ${booking.number_of_students}</p>` : ''}
                        ${booking.number_of_crew ? `<p><span class="font-semibold text-yellow-700">ÿßŸÑÿ∑ÿßŸÇŸÖ:</span> ${booking.number_of_crew}</p>` : ''}
                        ${booking.number_of_buses ? `<p><span class="font-semibold text-yellow-700">ÿßŸÑÿ≠ÿßŸÅŸÑÿßÿ™:</span> ${booking.number_of_buses}</p>` : ''}
                    </div>
                </div>
                `
                        : ''
                }

                ${
                    booking.services && booking.services.length > 0
                        ? `
                <!-- Services -->
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200 compact-section avoid-break-inside">
                    <h3 class="font-bold mb-2 text-sm text-gray-700 flex items-center gap-2">
                        üéØ ÿßŸÑÿÆÿØŸÖÿßÿ™ ÿßŸÑŸÖÿ≠ÿ¨Ÿàÿ≤ÿ©
                    </h3>
                    <table class="w-full text-xs">
                        <thead>
                            <tr class="bg-gray-200 text-right">
                                <th class="p-1.5 font-semibold">ÿßŸÑÿÆÿØŸÖÿ©</th>
                                <th class="p-1.5 font-semibold">ÿßŸÑŸÜŸàÿπ</th>
                                <th class="p-1.5 font-semibold text-center">ÿßŸÑŸÉŸÖŸäÿ©</th>
                                <th class="p-1.5 font-semibold text-center">ÿßŸÑÿ£ŸäÿßŸÖ</th>
                                <th class="p-1.5 font-semibold text-left">ÿßŸÑÿ≥ÿπÿ±</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${booking.services
                                .map(
                                    (service: any, index: number) => `
                                <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                    <td class="p-1.5">${service.name || 'ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±'}</td>
                                    <td class="p-1.5">${getServiceTypeLabel(service.type)}</td>
                                    <td class="p-1.5 text-center">${service.quantity}</td>
                                    <td class="p-1.5 text-center">${service.days}</td>
                                    <td class="p-1.5 text-left font-semibold">${formatCurrency(service.cost)}</td>
                                </tr>
                            `,
                                )
                                .join('')}
                        </tbody>
                    </table>
                </div>
                `
                        : ''
                }

                <!-- Financial Summary -->
                <div class="bg-gradient-to-br from-indigo-50 to-blue-50 rounded-lg p-3 border border-indigo-200 compact-section avoid-break-inside">
                    <h3 class="font-bold mb-2 text-sm text-indigo-700 flex items-center gap-2">
                        üí∞ ÿßŸÑŸÖŸÑÿÆÿµ ÿßŸÑŸÖÿßŸÑŸä
                    </h3>
                    <div class="space-y-1.5">
                        <div class="flex justify-between items-center text-xs">
                            <span class="font-semibold text-indigo-700">ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä:</span>
                            <span class="text-lg font-bold text-indigo-700">${formatCurrency(booking.total_amount)}</span>
                        </div>
                        <div class="flex justify-between items-center text-xs">
                            <span class="font-semibold text-indigo-700">ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ:</span>
                            <span>${getPaymentMethodLabel(booking.payment_method) || 'ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±'}</span>
                        </div>
                    </div>
                </div>

                ${
                    booking.notes || booking.special_requests
                        ? `
                <!-- Notes -->
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200 compact-section avoid-break-inside">
                    <h3 class="font-bold mb-2 text-sm text-gray-700 flex items-center gap-2">
                        üìù ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ©
                    </h3>
                    <div class="space-y-1.5 text-xs">
                        ${booking.notes ? `<p><span class="font-semibold text-gray-700">ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™:</span> ${booking.notes}</p>` : ''}
                        ${booking.special_requests ? `<p><span class="font-semibold text-gray-700">ÿ∑ŸÑÿ®ÿßÿ™ ÿÆÿßÿµÿ©:</span> ${booking.special_requests}</p>` : ''}
                    </div>
                </div>
                `
                        : ''
                }

                <!-- Footer -->
                <div class="text-center text-xs text-gray-500 pt-2 border-t border-gray-200">
                    <p>ÿ™ŸÖ ÿßŸÑÿ•ŸÜÿ¥ÿßÿ° ŸÅŸä ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                </div>
            </div>
        </div>
    </body>
    </html>
    `;
}

/**
 * Generate Hebrew booking HTML
 */
function generateHebrewBookingHTML(booking: any, companyInfo: any): string {
    const formatCurrency = (value: number) => {
        return new Intl.NumberFormat('he-IL', {
            style: 'currency',
            currency: 'ILS',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
        }).format(value);
    };

    const formatDate = (dateString: string) => {
        return new Date(dateString).toLocaleDateString('he-IL', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
        });
    };

    const getBookingTypeLabel = (bookingType: string): string => {
        const labels: { [key: string]: string } = {
            full_trip: '◊ò◊ô◊ï◊ú ◊û◊ú◊ê',
            guides_only: '◊û◊ì◊®◊ô◊õ◊ô◊ù ◊ë◊ú◊ë◊ì',
            paramedics_only: '◊§◊®◊û◊ì◊ô◊ß◊ô◊ù ◊ë◊ú◊ë◊ì',
            security_only: '◊ê◊ë◊ò◊ó◊î ◊ë◊ú◊ë◊ì',
            entertainment_only: '◊ë◊ô◊ì◊ï◊® ◊ë◊ú◊ë◊ì',
            education_only: '◊™◊ï◊õ◊†◊ô◊ï◊™ ◊ó◊ô◊†◊ï◊õ◊ô◊ï◊™ ◊ë◊ú◊ë◊ì',
            transportation_only: '◊î◊°◊¢◊ï◊™ ◊ë◊ú◊ë◊ì',
        };
        return labels[bookingType] || bookingType;
    };

    const getStatusLabel = (status: string): string => {
        const labels: { [key: string]: string } = {
            pending: '◊û◊û◊™◊ô◊ü',
            confirmed: '◊û◊ê◊ï◊©◊®',
            completed: '◊î◊ï◊©◊ú◊ù',
            cancelled: '◊ë◊ï◊ò◊ú',
            active: '◊§◊¢◊ô◊ú',
            inactive: '◊ú◊ê ◊§◊¢◊ô◊ú',
        };
        return labels[status] || status;
    };

    const getPaymentStatusLabel = (status: string): string => {
        const labels: { [key: string]: string } = {
            pending: '◊û◊û◊™◊ô◊ü',
            deposit_paid: '◊û◊ß◊ì◊û◊î ◊©◊ï◊ú◊û◊î',
            fully_paid: '◊©◊ï◊ú◊ù ◊ë◊û◊ú◊ï◊ê◊ï',
            paid: '◊©◊ï◊ú◊ù',
            cancelled: '◊ë◊ï◊ò◊ú',
        };
        return labels[status] || status;
    };

    const getServiceTypeLabel = (serviceType: string): string => {
        const labels: { [key: string]: string } = {
            guides: '◊û◊ì◊®◊ô◊õ◊ô◊ù',
            paramedics: '◊§◊®◊û◊ì◊ô◊ß◊ô◊ù',
            security_companies: '◊ó◊ë◊®◊ï◊™ ◊ê◊ë◊ò◊ó◊î',
            external_entertainment_companies: '◊ó◊ë◊®◊ï◊™ ◊ë◊ô◊ì◊ï◊®',
            travel_companies: '◊ó◊ë◊®◊ï◊™ ◊î◊°◊¢◊ï◊™',
            education_programs: '◊™◊ï◊õ◊†◊ô◊ï◊™ ◊ó◊ô◊†◊ï◊õ◊ô◊ï◊™',
        };
        return labels[serviceType] || serviceType;
    };

    const getPaymentMethodLabel = (paymentMethod: string): string => {
        const labels: { [key: string]: string } = {
            bank_transfer: '◊î◊¢◊ë◊®◊î ◊ë◊†◊ß◊ê◊ô◊™',
            cash: '◊û◊ñ◊ï◊û◊ü',
            credit_card: '◊õ◊®◊ò◊ô◊° ◊ê◊©◊®◊ê◊ô',
            check: '◊¶\'◊ß',
        };
        return labels[paymentMethod] || paymentMethod;
    };

    return `
    <!DOCTYPE html>
    <html lang="he">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>◊°◊ô◊õ◊ï◊ù ◊î◊ñ◊û◊†◊î - ${booking.booking_reference}</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700&display=swap" rel="stylesheet">
        <style>
            @page { size: A4; margin: 8mm; }
            body { 
                font-family: 'Heebo', 'Segoe UI', Arial, sans-serif; 
                font-size: 11px; 
                line-height: 1.4; 
            }
            .avoid-break-inside { page-break-inside: avoid; }
            .compact-section { margin-bottom: 8px; }
            .compact-header { padding: 12px 16px; }
            .compact-content { padding: 14px; }
        </style>
    </head>
    <body>
        <div class="bg-white w-full max-w-none" style="direction: rtl">
            <!-- Header -->
            <div class="relative overflow-hidden w-full avoid-break-inside">
                <div class="absolute inset-0 bg-gradient-to-r from-blue-600 to-indigo-600"></div>
                
                <div class="relative compact-header w-full">
                    <div class="flex items-center justify-between w-full">
                        <!-- Company Info -->
                        <div class="flex items-center gap-3 text-white">
                            ${
                                companyInfo?.logo_url
                                    ? `
                                <div class="bg-white/10 backdrop-blur-sm rounded-lg p-2 border border-white/20">
                                    <img src="${companyInfo.logo_url}" alt="◊ú◊ï◊í◊ï ◊î◊ó◊ë◊®◊î" class="w-10 h-10 object-contain" />
                                </div>
                            `
                                    : ''
                            }
                            <div class="text-right">
                                <h1 class="text-lg font-bold mb-0.5">${companyInfo?.name || '◊ó◊ë◊®◊™ ◊ò◊ô◊ï◊ú◊ô◊ù ◊ú◊ë◊™◊ô ◊°◊§◊®'}</h1>
                                <div class="space-y-0.5 text-xs opacity-90">
                                    ${companyInfo?.phone ? `<p>üìû ${companyInfo.phone}</p>` : ''}
                                    ${companyInfo?.address ? `<p>üìç ${companyInfo.address}</p>` : ''}
                                </div>
                            </div>
                        </div>

                        <!-- Booking Title -->
                        <div class="text-white text-left">
                            <h2 class="text-base font-bold mb-1">◊°◊ô◊õ◊ï◊ù ◊î◊ñ◊û◊†◊î</h2>
                            <div class="bg-white/10 backdrop-blur-sm rounded-lg px-3 py-1.5 border border-white/20">
                                <p class="text-xs font-medium">◊û◊°◊§◊® ◊ê◊°◊û◊õ◊™◊ê</p>
                                <p class="text-sm font-bold">${booking.booking_reference}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content -->
            <div class="compact-content space-y-3 w-full">
                <!-- Booking Details -->
                <div class="grid grid-cols-2 gap-3 w-full compact-section avoid-break-inside">
                    <!-- Main Info -->
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-3 border border-blue-200">
                        <h3 class="font-bold mb-2 text-sm text-blue-700 flex items-center gap-2">
                            üìã ◊§◊®◊ò◊ô ◊î◊î◊ñ◊û◊†◊î
                        </h3>
                        <div class="space-y-1 text-xs">
                            <p><span class="font-semibold text-blue-700">◊°◊ï◊í:</span> ${getBookingTypeLabel(booking.booking_type)}</p>
                            <p><span class="font-semibold text-blue-700">◊™◊ê◊®◊ô◊ö ◊î◊ò◊ô◊ï◊ú:</span> ${formatDate(booking.trip_date)}</p>
                            <p><span class="font-semibold text-blue-700">◊°◊ò◊ò◊ï◊°:</span> ${getStatusLabel(booking.status)}</p>
                            <p><span class="font-semibold text-blue-700">◊°◊ò◊ò◊ï◊° ◊™◊©◊ú◊ï◊ù:</span> ${getPaymentStatusLabel(booking.payment_status)}</p>
                        </div>
                    </div>

                    <!-- Customer Info -->
                    <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg p-3 border border-green-200">
                        <h3 class="font-bold mb-2 text-sm text-green-700 flex items-center gap-2">
                            üë§ ◊§◊®◊ò◊ô ◊ú◊ß◊ï◊ó
                        </h3>
                        <div class="space-y-1 text-xs">
                            <p><span class="font-semibold text-green-700">◊©◊ù:</span> ${booking.customer?.full_name || '◊ú◊ê ◊ñ◊û◊ô◊ü'}</p>
                            <p><span class="font-semibold text-green-700">◊ê◊ô◊û◊ô◊ô◊ú:</span> ${booking.customer?.email || '◊ú◊ê ◊ñ◊û◊ô◊ü'}</p>
                            <p><span class="font-semibold text-green-700">◊ò◊ú◊§◊ï◊ü:</span> ${booking.customer?.phone || '◊ú◊ê ◊ñ◊û◊ô◊ü'}</p>
                            ${booking.school?.name ? `<p><span class="font-semibold text-green-700">◊ë◊ô◊™ ◊°◊§◊®:</span> ${booking.school.name}</p>` : ''}
                        </div>
                    </div>
                </div>

                ${
                    booking.destination
                        ? `
                <!-- Destination -->
                <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg p-3 border border-purple-200 compact-section avoid-break-inside">
                    <h3 class="font-bold mb-2 text-sm text-purple-700 flex items-center gap-2">
                        üìç ◊ô◊¢◊ì
                    </h3>
                    <div class="space-y-1 text-xs">
                        <p><span class="font-semibold text-purple-700">◊©◊ù:</span> ${booking.destination.name}</p>
                        ${booking.destination.address ? `<p><span class="font-semibold text-purple-700">◊õ◊™◊ï◊ë◊™:</span> ${booking.destination.address}</p>` : ''}
                    </div>
                </div>
                `
                        : ''
                }

                ${
                    booking.number_of_students || booking.number_of_crew || booking.number_of_buses
                        ? `
                <!-- Trip Details -->
                <div class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-lg p-3 border border-yellow-200 compact-section avoid-break-inside">
                    <h3 class="font-bold mb-2 text-sm text-yellow-700 flex items-center gap-2">
                        üöå ◊§◊®◊ò◊ô ◊î◊ò◊ô◊ï◊ú
                    </h3>
                    <div class="grid grid-cols-3 gap-2 text-xs">
                        ${booking.number_of_students ? `<p><span class="font-semibold text-yellow-700">◊™◊ú◊û◊ô◊ì◊ô◊ù:</span> ${booking.number_of_students}</p>` : ''}
                        ${booking.number_of_crew ? `<p><span class="font-semibold text-yellow-700">◊¶◊ï◊ï◊™:</span> ${booking.number_of_crew}</p>` : ''}
                        ${booking.number_of_buses ? `<p><span class="font-semibold text-yellow-700">◊ê◊ï◊ò◊ï◊ë◊ï◊°◊ô◊ù:</span> ${booking.number_of_buses}</p>` : ''}
                    </div>
                </div>
                `
                        : ''
                }

                ${
                    booking.services && booking.services.length > 0
                        ? `
                <!-- Services -->
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200 compact-section avoid-break-inside">
                    <h3 class="font-bold mb-2 text-sm text-gray-700 flex items-center gap-2">
                        üéØ ◊©◊ô◊®◊ï◊™◊ô◊ù ◊©◊î◊ï◊ñ◊û◊†◊ï
                    </h3>
                    <table class="w-full text-xs">
                        <thead>
                            <tr class="bg-gray-200 text-right">
                                <th class="p-1.5 font-semibold">◊©◊ô◊®◊ï◊™</th>
                                <th class="p-1.5 font-semibold">◊°◊ï◊í</th>
                                <th class="p-1.5 font-semibold text-center">◊õ◊û◊ï◊™</th>
                                <th class="p-1.5 font-semibold text-center">◊ô◊û◊ô◊ù</th>
                                <th class="p-1.5 font-semibold text-left">◊û◊ó◊ô◊®</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${booking.services
                                .map(
                                    (service: any, index: number) => `
                                <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                                    <td class="p-1.5">${service.name || '◊ú◊ê ◊ñ◊û◊ô◊ü'}</td>
                                    <td class="p-1.5">${getServiceTypeLabel(service.type)}</td>
                                    <td class="p-1.5 text-center">${service.quantity}</td>
                                    <td class="p-1.5 text-center">${service.days}</td>
                                    <td class="p-1.5 text-left font-semibold">${formatCurrency(service.cost)}</td>
                                </tr>
                            `,
                                )
                                .join('')}
                        </tbody>
                    </table>
                </div>
                `
                        : ''
                }

                <!-- Financial Summary -->
                <div class="bg-gradient-to-br from-indigo-50 to-blue-50 rounded-lg p-3 border border-indigo-200 compact-section avoid-break-inside">
                    <h3 class="font-bold mb-2 text-sm text-indigo-700 flex items-center gap-2">
                        üí∞ ◊°◊ô◊õ◊ï◊ù ◊õ◊°◊§◊ô
                    </h3>
                    <div class="space-y-1.5">
                        <div class="flex justify-between items-center text-xs">
                            <span class="font-semibold text-indigo-700">◊°◊õ◊ï◊ù ◊õ◊ï◊ú◊ú:</span>
                            <span class="text-lg font-bold text-indigo-700">${formatCurrency(booking.total_amount)}</span>
                        </div>
                        <div class="flex justify-between items-center text-xs">
                            <span class="font-semibold text-indigo-700">◊ê◊û◊¶◊¢◊ô ◊™◊©◊ú◊ï◊ù:</span>
                            <span>${getPaymentMethodLabel(booking.payment_method) || '◊ú◊ê ◊ñ◊û◊ô◊ü'}</span>
                        </div>
                    </div>
                </div>

                ${
                    booking.notes || booking.special_requests
                        ? `
                <!-- Notes -->
                <div class="bg-gray-50 rounded-lg p-3 border border-gray-200 compact-section avoid-break-inside">
                    <h3 class="font-bold mb-2 text-sm text-gray-700 flex items-center gap-2">
                        üìù ◊û◊ô◊ì◊¢ ◊†◊ï◊°◊£
                    </h3>
                    <div class="space-y-1.5 text-xs">
                        ${booking.notes ? `<p><span class="font-semibold text-gray-700">◊î◊¢◊®◊ï◊™:</span> ${booking.notes}</p>` : ''}
                        ${booking.special_requests ? `<p><span class="font-semibold text-gray-700">◊ë◊ß◊©◊ï◊™ ◊û◊ô◊ï◊ó◊ì◊ï◊™:</span> ${booking.special_requests}</p>` : ''}
                    </div>
                </div>
                `
                        : ''
                }

                <!-- Footer -->
                <div class="text-center text-xs text-gray-500 pt-2 border-t border-gray-200">
                    <p>◊†◊ï◊¶◊® ◊ë◊™◊ê◊®◊ô◊ö ${new Date().toLocaleDateString('he-IL', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                </div>
            </div>
        </div>
    </body>
    </html>
    `;
}
